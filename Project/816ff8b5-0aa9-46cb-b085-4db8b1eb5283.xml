{"CLs":[{"__type":"IST","EID":"a27a1337-a158-4bba-ab47-15760f6a24ac","H":498.80000000000024,"TXT":"CASE Drive3State OF\u000d\u000a\u0009Idle:\u000d\u000a\u0009\u0009BLVDoUpdateTimer_Run := TRUE; \/\/ Run update timer - Ensure updates are roughly 1s apart\u000d\u000a\u0009\u0009IF NOT Param.ConveyorEnable AND NOT Param.PalletConveyorEnable THEN\u000d\u000a\u0009\u0009\u0009BLVDesiredState := Idle;\u000d\u000a\u0009\u0009\u0009Drive3State := Idle;\u000d\u000a\u0009\u0009ELSIF Drive3Data.InCmd.AsWord <> PrevInCmd OR RequestUpdateBLV THEN\u000d\u000a\u0009\u0009\u0009BLVDesiredState := SendInCmd; \/\/ If drive in cmd has changed, update the drive\u000d\u000a\u0009\u0009\u0009Drive3State := WaitForPort;\u000d\u000a\u0009\u0009ELSIF Drive3Data.Update.Request THEN\u000d\u000a\u0009\u0009\u0009Drive3Data.Update.Busy := TRUE;\u000d\u000a\u0009\u0009\u0009BLVDesiredState := GetOutCmd;\u000d\u000a\u0009\u0009\u0009Drive3State := WaitForPort;\u000d\u000a\u0009\u0009ELSIF BLVDoUpdateTimer_Done THEN\u000d\u000a\u0009\u0009\u0009BLVDesiredState := GetOutCmd; \/\/ If 1 second has elapsed since last update, update status (out cmd)\u000d\u000a\u0009\u0009\u0009Drive3State := WaitForPort;\u000d\u000a\u0009\u0009ELSIF Drive3Data.Reset.Request THEN\u000d\u000a\u0009\u0009\u0009Drive3Data.Reset.Busy := TRUE;\u000d\u000a\u0009\u0009\u0009BLVAlmResetData := WORD#16#1;\u000d\u000a\u0009\u0009\u0009BLVDesiredState := SendAlarmReset;\u000d\u000a\u0009\u0009\u0009Drive3State := WaitForPort;\u000d\u000a\u0009\u0009ELSIF RequestBLVClearReset THEN\u000d\u000a\u0009\u0009\u0009BLVAlmResetData := WORD#16#0;\u000d\u000a\u0009\u0009\u0009BLVDesiredState := SendAlarmReset;\u000d\u000a\u0009\u0009\u0009Drive3State := WaitForPort;\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u000d\u000a\u0009WaitForPort:\u000d\u000a\u0009IF Drive1State = Idle AND Drive2State = Idle THEN\u000d\u000a\u0009\u0009Drive3State := BLVDesiredState;\u000d\u000a\u0009END_IF;\u000d\u000a\u000d\u000a\u0009SendInCmd:\u000d\u000a\u0009\u0009UpdateInCmd := TRUE; \/\/ Raise flag to do modbus write\u000d\u000a\u0009\u0009IF InCmdUpdated THEN  \/\/ Wait for completion\u000d\u000a\u0009\u0009\u0009Drive3State := Idle; \/\/ Return to idle on completion\u000d\u000a\u0009\u0009\u0009UpdateInCmd := FALSE; \/\/ Lower Flag\u000d\u000a\u0009\u0009\u0009Drive3Data.CommsFault := FALSE;\u000d\u000a\u0009\u0009ELSIF BLVInCmdError THEN \/\/ if comms error\u000d\u000a\u0009\u0009\u0009Drive3State := Idle; \/\/ return to idle state\u000d\u000a\u0009\u0009\u0009UpdateInCmd := FALSE; \/\/ Lower flag\u000d\u000a\u0009\u0009\u0009IF Drive3Data.CommsFault THEN\u000d\u000a\u0009\u0009\u0009\u0009Inc(Drive3Data.CommsFaultCount);\u000d\u000a\u0009\u0009\u0009ELSE\u000d\u000a\u0009\u0009\u0009\u0009Drive3Data.CommsFaultCount := 0;\u000d\u000a\u0009\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u0009Drive3Data.CommsFault := TRUE; \/\/ set error flag\u000d\u000a\u0009\u0009\u0009Drive3Data.CommsFaultCode := BLVInCmdErrorID; \/\/ store error code\u000d\u000a\u0009\u0009\u0009\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u000d\u000a\u0009GetOutCmd:\u000d\u000a\u0009    BLVDoUpdateTimer_Run := FALSE; \/\/ Stop Timer\u000d\u000a\u0009    UpdateOutCmd := TRUE; \/\/ Raise flag to do modbus read\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009IF OutCmdUpdated THEN\u000d\u000a\u0009\u0009\u0009IF Drive3Data.OutCmd.Bit[3] <> Drive3Data.InCmd.Bit[3] OR\u000d\u000a\u0009\u0009\u0009\u0009Drive3Data.OutCmd.Bit[4] <> Drive3Data.InCmd.Bit[4] OR\u000d\u000a\u0009\u0009\u0009\u0009Drive3Data.OutCmd.Bit[5] <> Drive3Data.InCmd.Bit[5] THEN\u000d\u000a\u0009\u0009\u0009\u0009Drive3State := SendInCmd; \/\/ Check fwd, rev, stopmode matches desired values\u000d\u000a\u0009\u0009\u0009ELSIF Drive3Data.OutCmd.Bit[7] THEN \/\/ If alarm flag set, get alarm code\u000d\u000a\u0009\u0009\u0009\u0009Drive3State := GetAlarmCode;\u000d\u000a\u0009\u0009\u0009ELSIF Drive3Data.OutCmd.Bit[6] THEN\u000d\u000a\u0009\u0009\u0009\u0009Drive3State := GetWarningCode; \/\/ If no alarm & warning flag set, get warning code\u000d\u000a\u0009\u0009\u0009ELSE\u000d\u000a\u0009\u0009\u0009\u0009Drive3State := Idle; \/\/ If neither alarm nor warning flag set, return to idle\u000d\u000a\u0009\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u0009Drive3Data.CommsFault := FALSE;\u000d\u000a\u0009\u0009\u0009UpdateOutCmd := FALSE; \/\/ Lower flag\u000d\u000a\u0009\u0009\u0009\u000d\u000a\u0009\u0009\u0009IF Drive3Data.Update.Request THEN \u000d\u000a\u0009\u0009\u0009\u0009Drive3Data.Update.Busy := FALSE;\u000d\u000a\u0009\u0009\u0009\u0009Drive3Data.Update.Done := TRUE;\u000d\u000a\u0009\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u0009\u000d\u000a\u0009\u0009ELSIF BLVOutCmdError THEN \/\/ if comms error\u000d\u000a\u0009\u0009\u0009\u000d\u000a\u0009\u0009\u0009Drive3State := Idle; \/\/ return to idle state\u000d\u000a\u0009\u0009\u0009UpdateOutCmd := FALSE; \/\/ Lower flag\u000d\u000a\u0009\u0009\u0009IF Drive3Data.CommsFault THEN\u000d\u000a\u0009\u0009\u0009\u0009Inc(Drive3Data.CommsFaultCount);\u000d\u000a\u0009\u0009\u0009ELSE\u000d\u000a\u0009\u0009\u0009\u0009Drive3Data.CommsFaultCount := 0;\u000d\u000a\u0009\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u0009Drive3Data.CommsFault := TRUE; \/\/ set error flag\u000d\u000a\u0009\u0009\u0009Drive3Data.CommsFaultCode := BLVOutCmdErrorID; \/\/ store error code\u000d\u000a\u0009\u0009\u0009\u000d\u000a\u0009\u0009\u0009IF Drive3Data.Update.Request THEN \u000d\u000a\u0009\u0009\u0009\u0009Drive3Data.Update.Busy := FALSE;\u000d\u000a\u0009\u0009\u0009\u0009Drive3Data.Update.Error := TRUE;\u000d\u000a\u0009\u0009\u0009END_IF;\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u000d\u000a\u0009GetAlarmCode:\u000d\u000a\u0009    BLVUpdateAlm := TRUE; \/\/ Raise flag to do modbus read\u000d\u000a\u0009\u0009IF BLVAlmUpdated THEN \/\/ Wait for read complete\u000d\u000a\u0009\u0009\u0009IF Drive3Data.OutCmd.Bit[6] THEN\u000d\u000a\u0009\u0009\u0009\u0009Drive3State := GetWarningCode; \/\/ If warning flag set, get warning next\u000d\u000a\u0009\u0009\u0009ELSE\u000d\u000a\u0009\u0009\u0009\u0009Drive3State := Idle; \/\/ If no warning, return to idle\u000d\u000a\u0009\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u0009Drive3Data.CommsFault := FALSE;\u000d\u000a\u0009\u0009\u0009BLVUpdateAlm := FALSE; \/\/ Lower flag\u000d\u000a\u0009\u0009ELSIF BLVAlmError THEN \/\/ if comms error\u000d\u000a\u0009\u0009\u0009Drive3State := Idle; \/\/ return to idle state\u000d\u000a\u0009\u0009\u0009BLVUpdateAlm := FALSE; \/\/ Lower flag\u000d\u000a\u0009\u0009\u0009IF Drive3Data.CommsFault THEN\u000d\u000a\u0009\u0009\u0009\u0009Inc(Drive3Data.CommsFaultCount);\u000d\u000a\u0009\u0009\u0009ELSE\u000d\u000a\u0009\u0009\u0009\u0009Drive3Data.CommsFaultCount := 0;\u000d\u000a\u0009\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u0009Drive3Data.CommsFault := TRUE; \/\/ set error flag\u000d\u000a\u0009\u0009\u0009Drive3Data.CommsFaultCode := BLVAlmErrorID; \/\/ store error code\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u000d\u000a\u0009GetWarningCode:\u000d\u000a\u0009\u0009BLVUpdateWarn := TRUE; \/\/ Raise flag\u000d\u000a\u0009\u0009IF BLVWarnUpdated THEN \/\/ Wait for completion\u000d\u000a\u0009\u0009\u0009Drive3State := Idle; \/\/ Return to idle on completion\u000d\u000a\u0009\u0009\u0009Drive3Data.CommsFault := FALSE;\u000d\u000a\u0009\u0009\u0009BLVUpdateWarn := FALSE; \/\/ Lower flag\u000d\u000a\u0009\u0009ELSIF BLVWarnError THEN \/\/ if comms error\u000d\u000a\u0009\u0009\u0009Drive3State := Idle; \/\/ return to idle state\u000d\u000a\u0009\u0009\u0009BLVUpdateWarn := FALSE; \/\/ Lower flag\u000d\u000a\u0009\u0009\u0009IF Drive3Data.CommsFault THEN\u000d\u000a\u0009\u0009\u0009\u0009Inc(Drive3Data.CommsFaultCount);\u000d\u000a\u0009\u0009\u0009ELSE\u000d\u000a\u0009\u0009\u0009\u0009Drive3Data.CommsFaultCount := 0;\u000d\u000a\u0009\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u0009Drive3Data.CommsFault := TRUE; \/\/ set error flag\u000d\u000a\u0009\u0009\u0009Drive3Data.CommsFaultCode := BLVWarnErrorID; \/\/ store error code\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u000d\u000a\u0009SendAlarmReset:\u000d\u000a\u0009\u0009BLVAlmReset := TRUE; \/\/ Raise flag to do modbus write\u000d\u000a\u0009\u0009IF BLVAlmResetDone THEN \/\/ Wait for completion\u000d\u000a\u0009\u0009\u0009IF RequestBLVClearReset THEN\u000d\u000a\u0009\u0009\u0009\u0009RequestBLVClearReset := FALSE;\u000d\u000a\u0009\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u0009IF Drive3Data.Reset.Request THEN\u000d\u000a\u0009\u0009\u0009\u0009Drive3Data.Reset.Busy := FALSE;\u000d\u000a\u0009\u0009\u0009\u0009Drive3Data.Reset.Done := TRUE;\u000d\u000a\u0009\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u0009Drive3State := Idle; \/\/ Return to idle on completion\u000d\u000a\u0009\u0009\u0009BLVCommsFault := FALSE;\u000d\u000a\u0009\u0009\u0009BLVAlmReset := FALSE; \/\/ Lower flag\u000d\u000a\u0009\u0009\u0009ELSIF BLVAlmResetError THEN \/\/ if comms error\u000d\u000a\u0009\u0009\u0009Drive3State := Idle; \/\/ return to idle state\u000d\u000a\u0009\u0009\u0009BLVAlmReset := FALSE; \/\/ Lower flag\u000d\u000a\u0009\u0009\u0009IF Drive3Data.CommsFault THEN\u000d\u000a\u0009\u0009\u0009\u0009Inc(Drive3Data.CommsFaultCount);\u000d\u000a\u0009\u0009\u0009ELSE\u000d\u000a\u0009\u0009\u0009\u0009Drive3Data.CommsFaultCount := 0;\u000d\u000a\u0009\u0009\u0009END_IF;\u000d\u000a\u0009\u0009\u0009BLVCommsFault := TRUE; \/\/ set error flag\u000d\u000a\u0009\u0009\u0009BLVCommsFaultCode := BLVAlmResetErrorID; \/\/ store error code\u000d\u000a\u0009\u0009\u000d\u000a\u0009\u0009\u0009IF Drive3Data.Reset.Request THEN\u000d\u000a\u0009\u0009\u0009\u0009Drive3Data.Reset.Busy := FALSE;\u000d\u000a\u0009\u0009\u0009\u0009Drive3Data.Reset.Error := TRUE;\u000d\u000a\u0009\u0009\u0009END_IF;\u000d\u000a\u0009\u0009END_IF;\u000d\u000a\u0009ELSE\u000d\u000a\u0009\u0009Drive3State := Idle; \/\/ Prevent unhandled state\u000d\u000aEND_CASE;\u000d\u000aPrevInCmd := Drive3Data.InCmd.AsWord; \/\/ Update diff\u000d\u000a\u000d\u000a\/\/ Clear error & done flags when request = false\u000d\u000aIF NOT Drive3Data.Update.Request THEN\u000d\u000a\u0009Drive3Data.Update.Done := FALSE;\u000d\u000a\u0009Drive3Data.Update.Error := FALSE;\u000d\u000aEND_IF;\u000d\u000aIF NOT Drive3Data.Reset.Request THEN\u000d\u000a\u0009Drive3Data.Reset.Done := FALSE;\u000d\u000a\u0009Drive3Data.Reset.Error := FALSE;\u000d\u000aEND_IF;","W":800}],"LRI":1,"RRI":2,"VLs":[]}
{"CLs":[{"__type":"LD","Var":"BLVDoUpdateTimer_Run"},{"__type":"LD","Ix":1,"Var":"AllowUpdate","X":1},{"__type":"LD","Ix":2,"Var":"Param.ConveyorEnable","X":2},{"__type":"LD","Ix":3,"Var":"Param.PalletConveyorEnable","X":2,"Y":1},{"__type":"FB","In":[{"__type":"PF","Arg":"In"},{"__type":"PRM","Arg":"PT","Ix":5,"Type":"TIME","Var":"T#1.1s"}],"Ix":7,"Name":"TON","Out":[{"__type":"PF","Arg":"Q"},{"__type":"PRM","Arg":"ET","Ix":6,"Type":"TIME","Var":"BLVUpdateTimerET"}],"X":3,"Var":"BLVDoUpdateTimer_FB"},{"__type":"ST","Ix":4,"Var":"BLVDoUpdateTimer_Done","X":4}],"LRI":8,"RRI":9,"VLs":[{"Ix":10,"X":2},{"Ix":11,"X":3}]}
